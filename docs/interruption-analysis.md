# Pipecat ä¸­æ–­æœºåˆ¶åˆ†ææŠ¥å‘Š

## æ¦‚è¿°

æœ¬æŠ¥å‘Šè¯¦ç»†åˆ†æäº†é¡¹ç›®ä¸­ **Interruptionï¼ˆä¸­æ–­ï¼‰** æœºåˆ¶çš„å®ç°ï¼ŒåŒ…æ‹¬æ‰€æœ‰å…³é”®ç»„ä»¶çš„ä¸­æ–­å¤„ç†é€»è¾‘ã€‚

---

## 1. ä¸­æ–­å¸§ç±»å‹

### æ ¸å¿ƒä¸­æ–­å¸§ï¼ˆpipecat_adapters.py:19ï¼‰

```python
from pipecat.frames.frames import (
    InterruptionFrame,          # âœ… å®˜æ–¹ä¸­æ–­å¸§ï¼ˆSystemFrameï¼‰
    TTSStoppedFrame,            # âœ… TTS åœæ­¢å¸§
    UserStartedSpeakingFrame,   # âœ… ç”¨æˆ·å¼€å§‹è¯´è¯
    UserStoppedSpeakingFrame,   # âœ… ç”¨æˆ·åœæ­¢è¯´è¯
)
```

**é‡è¦ç‰¹æ€§**ï¼š
- `InterruptionFrame` æ˜¯ **SystemFrame**ï¼Œç»•è¿‡é˜Ÿåˆ—ç«‹å³å¤„ç†
- ç¡®ä¿ä¸­æ–­ä¿¡å·æœ€å¿«ä¼ é€’åˆ°æ‰€æœ‰å¤„ç†å™¨

---

## 2. ä¸­æ–­å‘é€ï¼šKWS å¤„ç†å™¨

### å”¤é†’è¯æ£€æµ‹è§¦å‘ä¸­æ–­ï¼ˆpipecat_adapters.py:63-78ï¼‰

```python
class SherpaKWSProcessor(FrameProcessor):
    async def process_frame(self, frame, direction):
        if isinstance(frame, AudioRawFrame):
            # ... éŸ³é¢‘å¤„ç† ...

            result = self.kws_model.get_result(self.kws_stream)

            if result:  # âœ… æ£€æµ‹åˆ°å”¤é†’è¯
                print(f"ğŸ”” æ£€æµ‹åˆ°å”¤é†’è¯: {result}")
                self.is_awake = True

                # âœ… 1. å‘é€ç”¨æˆ·å¼€å§‹è¯´è¯ä¿¡å·
                await self.push_frame(
                    UserStartedSpeakingFrame(),
                    direction
                )

                # âœ… 2. å‘é€ä¸­æ–­å¸§ï¼ˆè§¦å‘ä¸­æ–­ï¼‰
                await self.push_frame(
                    InterruptionFrame(),
                    direction
                )

                # é‡ç½® KWS æµ
                self.kws_stream = self.kws_model.create_stream()
```

**ä¸­æ–­è§¦å‘æ—¶æœº**ï¼š
- æ£€æµ‹åˆ°å”¤é†’è¯ç«‹å³å‘é€ `InterruptionFrame`
- å³ä½¿ TTS æ­£åœ¨æ’­æ”¾ï¼Œä¹Ÿä¼šè§¦å‘ä¸­æ–­

**æµ‹è¯•åœºæ™¯**ï¼š
```
åœºæ™¯ï¼šTTS æ­£åœ¨æ’­æ”¾ â†’ ç”¨æˆ·è¯´"å°æ™º" â†’ InterruptionFrame å‘é€
é¢„æœŸï¼šTTS ç«‹å³åœæ­¢ï¼ŒASR å¼€å§‹å½•éŸ³
```

---

## 3. ä¸­æ–­å“åº”ï¼šASR å¤„ç†å™¨

### æ¥æ”¶ä¸­æ–­å¼€å§‹å½•éŸ³ï¼ˆpipecat_adapters.py:123-133ï¼‰

```python
class SherpaASRProcessor(FrameProcessor):
    async def process_frame(self, frame, direction):
        # âœ… æ£€æµ‹å®˜æ–¹ä¸­æ–­å¸§ï¼Œå¼€å§‹å½•éŸ³
        if isinstance(frame, InterruptionFrame):
            print("ğŸ“ å¼€å§‹å½•éŸ³è¯†åˆ«...")
            self.recording = True
            self.buffer = []
            self.silence_count = 0
            self.has_speech = False
            self.frame_count = 0

            # ä¼ é€’ä¸­æ–­å¸§ï¼ˆç»§ç»­ä¼ é€’ç»™ä¸‹æ¸¸ï¼‰
            await self.push_frame(frame, direction)
            return
```

**ä¸­æ–­å“åº”è¡Œä¸º**ï¼š
1. æ£€æµ‹åˆ° `InterruptionFrame`
2. è®¾ç½® `recording = True`
3. æ¸…ç©ºç¼“å†²åŒºï¼ˆå‡†å¤‡å½•åˆ¶æ–°éŸ³é¢‘ï¼‰
4. é‡ç½®é™éŸ³æ£€æµ‹çŠ¶æ€

**ä½œç”¨**ï¼š
- ç¡®ä¿å”¤é†’è¯è§¦å‘åï¼ŒASR ç«‹å³å‡†å¤‡å½•éŸ³
- æ¸…é™¤ä¹‹å‰çš„éŸ³é¢‘ç¼“å†²ï¼Œé¿å…å½•å…¥æ—§æ•°æ®

---

## 4. ä¸­æ–­å¤„ç†ï¼šTTS å¤„ç†å™¨

### 4.1 ä¸­æ–­æ£€æµ‹ä¸å“åº”ï¼ˆpipecat_adapters.py:323-331ï¼‰

```python
class PiperTTSProcessor(FrameProcessor):
    def interrupt(self):
        """ä¸­æ–­å½“å‰TTSæ’­æ”¾"""
        self.interrupt_flag = True

    async def process_frame(self, frame, direction):
        # âœ… å“åº”å®˜æ–¹ä¸­æ–­å¸§ï¼Œè®¾ç½®ä¸­æ–­
        if isinstance(frame, InterruptionFrame):
            if self.is_speaking:
                print("â¸ï¸  æ£€æµ‹åˆ°ä¸­æ–­ä¿¡å·ï¼Œåœæ­¢TTSæ’­æ”¾")
                self.interrupt()  # è®¾ç½®ä¸­æ–­æ ‡å¿—

            # æ¸…ç©ºç¼“å†²åŒºï¼ˆä¸¢å¼ƒæœªæ’­æ”¾çš„å¥å­ï¼‰
            self.sentence_buffer = ""

            # ä¼ é€’ä¸­æ–­å¸§
            await self.push_frame(frame, direction)
            return
```

**ä¸­æ–­å“åº”è¡Œä¸º**ï¼š
1. æ£€æµ‹åˆ° `InterruptionFrame`
2. å¦‚æœæ­£åœ¨æ’­æ”¾ï¼ˆ`is_speaking = True`ï¼‰ï¼Œè°ƒç”¨ `interrupt()`
3. è®¾ç½® `interrupt_flag = True`
4. æ¸…ç©ºå¥å­ç¼“å†²ï¼ˆä¸¢å¼ƒæœªæ’­æ”¾çš„æ–‡æœ¬ï¼‰

### 4.2 åˆæˆå¾ªç¯ä¸­çš„ä¸­æ–­æ£€æŸ¥ï¼ˆpipecat_adapters.py:410-413ï¼‰

```python
def _synthesize_and_push_sync(self, text: str) -> bool:
    """åŒæ­¥ TTS åˆæˆï¼Œæ”¯æŒä¸­æ–­"""
    if self.tts.engine_type == "piper":
        audio_generator = self.tts.piper_voice.synthesize(text)

        for chunk in audio_generator:
            # âœ… æ¯ä¸ªéŸ³é¢‘å—éƒ½æ£€æŸ¥ä¸­æ–­æ ‡å¿—
            if self.interrupt_flag:
                print("â¸ï¸  TTS åˆæˆå·²ä¸­æ–­")
                return True  # è¿”å›ä¸­æ–­æ ‡å¿—

            # ç”ŸæˆéŸ³é¢‘å¸§
            audio_int16 = (chunk.audio_float_array * 32767).astype(np.int16)
            audio_frame = OutputAudioRawFrame(...)

            # æ¨é€åˆ° Pipeline
            await self.push_frame(audio_frame, FrameDirection.DOWNSTREAM)

        return False  # æ­£å¸¸å®Œæˆ
```

**ä¸­æ–­æ£€æŸ¥ç²’åº¦**ï¼š
- **æ¯ä¸ªéŸ³é¢‘å—**ï¼ˆchunkï¼‰éƒ½æ£€æŸ¥ `interrupt_flag`
- Piper éŸ³é¢‘å—é€šå¸¸ä¸º **~0.1-0.2 ç§’**
- ä¸­æ–­å»¶è¿Ÿï¼š**< 200ms**

### 4.3 ä¸­æ–­å®Œæˆåçš„æ¸…ç†ï¼ˆpipecat_adapters.py:384-392ï¼‰

```python
async def _synthesize_and_push(self, text: str):
    """å¼‚æ­¥åˆæˆå¹¶æ¨é€éŸ³é¢‘å¸§"""
    self.interrupt_flag = False  # âœ… é‡ç½®ä¸­æ–­æ ‡å¿—
    self.is_speaking = True

    was_interrupted = await asyncio.to_thread(
        self._synthesize_and_push_sync,
        text
    )

    self.is_speaking = False
    if was_interrupted:
        print("â¸ï¸  TTS å·²è¢«ä¸­æ–­")
        await self.push_frame(TTSStoppedFrame(), FrameDirection.DOWNSTREAM)
```

**ä¸­æ–­åæ¸…ç†**ï¼š
1. åˆæˆå‰é‡ç½® `interrupt_flag = False`
2. å¦‚æœè¢«ä¸­æ–­ï¼Œè®¾ç½® `is_speaking = False`
3. å‘é€ `TTSStoppedFrame` é€šçŸ¥ä¸‹æ¸¸

---

## 5. Pipeline é…ç½®

### å¯ç”¨ä¸­æ–­æœºåˆ¶ï¼ˆpipecat_main_v2.py:246ï¼‰

```python
task = PipelineTask(
    pipeline,
    params=PipelineParams(
        allow_interruptions=True,  # âœ… å¯ç”¨å®˜æ–¹ä¸­æ–­æœºåˆ¶
        audio_in_sample_rate=16000,
        audio_out_sample_rate=16000,
    )
)
```

**é…ç½®è¯´æ˜**ï¼š
- `allow_interruptions=True` å¯ç”¨ Pipecat å®˜æ–¹ä¸­æ–­æ”¯æŒ
- ç¡®ä¿ `SystemFrame` ä¼˜å…ˆå¤„ç†
- å…è®¸ `InterruptionFrame` ç»•è¿‡é˜Ÿåˆ—

---

## 6. å®Œæ•´ä¸­æ–­æµç¨‹

### åœºæ™¯ï¼šTTS æ’­æ”¾æ—¶æ£€æµ‹åˆ°å”¤é†’è¯

```
æ—¶é—´çº¿ï¼š
  T0: TTS æ­£åœ¨æ’­æ”¾ "ä»Šå¤©å¤©æ°”å¾ˆå¥½ï¼Œæ°”æ¸©25åº¦..."
  T1: ç”¨æˆ·è¯´ "å°æ™º"ï¼ˆå”¤é†’è¯ï¼‰
  T2: KWS æ£€æµ‹åˆ°å”¤é†’è¯
  T3: å‘é€ InterruptionFrame
  T4: TTS æ£€æµ‹åˆ°ä¸­æ–­ï¼Œåœæ­¢æ’­æ”¾
  T5: ASR å¼€å§‹å½•éŸ³
  T6: ç”¨æˆ·è¯´æ–°æŒ‡ä»¤ "æ˜å¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"
```

### è¯¦ç»†æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ·è¯´å”¤é†’è¯ "å°æ™º"                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. KWS Processor                                     â”‚
â”‚    - æ£€æµ‹åˆ°å”¤é†’è¯                                     â”‚
â”‚    - å‘é€ UserStartedSpeakingFrame                   â”‚
â”‚    - å‘é€ InterruptionFrame â—„â”€â”€ ä¸­æ–­è§¦å‘ç‚¹           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ (SystemFrameï¼Œç«‹å³ä¼ æ’­)
                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚
        â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ASR Processor â”‚  â”‚ 4. TTS Processor â”‚
â”‚  - æ£€æµ‹ä¸­æ–­å¸§     â”‚  â”‚  - æ£€æµ‹ä¸­æ–­å¸§     â”‚
â”‚  - recording=Trueâ”‚  â”‚  - è°ƒç”¨ interruptâ”‚
â”‚  - æ¸…ç©ºbuffer    â”‚  â”‚  - interrupt_flagâ”‚
â”‚  - å‡†å¤‡å½•éŸ³      â”‚  â”‚    = True        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  - æ¸…ç©ºç¼“å†²      â”‚
                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ 5. åˆæˆå¾ªç¯       â”‚
                      â”‚  - æ£€æŸ¥ flag     â”‚
                      â”‚  - ç«‹å³é€€å‡º      â”‚
                      â”‚  - åœæ­¢æ’­æ”¾      â”‚
                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ 6. å‘é€          â”‚
                      â”‚ TTSStoppedFrame  â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. ä¸­æ–­æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| **ä¸­æ–­å»¶è¿Ÿ** | < 200ms | ä»æ£€æµ‹åˆ°å”¤é†’è¯åˆ° TTS åœæ­¢ |
| **å¸§ç±»å‹** | SystemFrame | ç»•è¿‡é˜Ÿåˆ—ï¼Œç«‹å³å¤„ç† |
| **æ£€æŸ¥ç²’åº¦** | æ¯ä¸ª chunk | ~0.1-0.2 ç§’æ£€æŸ¥ä¸€æ¬¡ |
| **ç¼“å†²æ¸…ç†** | ç«‹å³ | ä¸­æ–­æ—¶æ¸…ç©ºå¥å­ç¼“å†² |

---

## 8. æµ‹è¯•æ–¹æ³•

### è‡ªåŠ¨åŒ–æµ‹è¯•

```bash
uv run test_interruption.py
```

**æµ‹è¯•å†…å®¹**ï¼š
1. âœ… ä¸­æ–­å¸§å¯¼å…¥å’Œç±»å‹æ£€æŸ¥
2. âœ… å®Œæ•´ä¸­æ–­æµç¨‹è®¾è®¡éªŒè¯

### æ‰‹åŠ¨æµ‹è¯•

**æ­¥éª¤**ï¼š
1. è¿è¡Œä¸»ç¨‹åºï¼š`uv run python -m src.voice_assistant.pipecat_main_v2`
2. è¯´å”¤é†’è¯ï¼š"å°æ™º"
3. ç­‰å¾… TTS å¼€å§‹æ’­æ”¾
4. åœ¨ TTS æ’­æ”¾è¿‡ç¨‹ä¸­å†æ¬¡è¯´ï¼š"å°æ™º"
5. è§‚å¯Ÿ TTS æ˜¯å¦ç«‹å³åœæ­¢

**é¢„æœŸç»“æœ**ï¼š
```
ğŸ”” æ£€æµ‹åˆ°å”¤é†’è¯: å°æ™º
ğŸ”Š TTS åˆæˆ: ä»Šå¤©å¤©æ°”å¾ˆå¥½...
[æ’­æ”¾ä¸­...]
ğŸ”” æ£€æµ‹åˆ°å”¤é†’è¯: å°æ™º
â¸ï¸  æ£€æµ‹åˆ°ä¸­æ–­ä¿¡å·ï¼Œåœæ­¢TTSæ’­æ”¾
â¸ï¸  TTS åˆæˆå·²ä¸­æ–­
ğŸ“ å¼€å§‹å½•éŸ³è¯†åˆ«...
```

---

## 9. å·²çŸ¥é—®é¢˜ä¸é™åˆ¶

### âœ… å·²è§£å†³çš„é—®é¢˜

1. **TTS ç›´æ¥æ’­æ”¾**ï¼ˆv1.0ï¼‰
   - âŒ æ—§å®ç°ï¼šç›´æ¥å†™å…¥éŸ³é¢‘æµï¼Œéš¾ä»¥ä¸­æ–­
   - âœ… æ–°å®ç°ï¼šç”Ÿæˆ `OutputAudioRawFrame`ï¼Œæ”¯æŒå¿«é€Ÿä¸­æ–­

2. **ä¸­æ–­æ ‡å¿—æ£€æŸ¥**
   - âœ… æ¯ä¸ªéŸ³é¢‘å—éƒ½æ£€æŸ¥ `interrupt_flag`
   - âœ… ä¸­æ–­å»¶è¿Ÿ < 200ms

### å½“å‰é™åˆ¶

1. **LLM ç”Ÿæˆä¸­æ–­**
   - LLM æ­£åœ¨ç”Ÿæˆæ–‡æœ¬æ—¶ï¼Œæ— æ³•ç«‹å³ä¸­æ–­
   - éœ€è¦ç­‰å¾…å½“å‰ token å®Œæˆ
   - å½±å“ï¼šä¸­æ–­å»¶è¿Ÿå¯èƒ½å¢åŠ  50-100ms

2. **MCP å·¥å…·è°ƒç”¨**
   - å·¥å…·æ­£åœ¨æ‰§è¡Œæ—¶ï¼ˆå¦‚ browser_clickï¼‰ï¼Œæ— æ³•ä¸­æ–­
   - éœ€è¦ç­‰å¾…å·¥å…·è°ƒç”¨å®Œæˆ
   - å»ºè®®ï¼šå·¥å…·è¶…æ—¶è®¾ç½®åˆç†å€¼

---

## 10. æ€»ç»“

### âœ… ä¸­æ–­æœºåˆ¶ä¼˜åŠ¿

1. **å¿«é€Ÿå“åº”**ï¼š< 200ms ä¸­æ–­å»¶è¿Ÿ
2. **å®Œæ•´å®ç°**ï¼šæ‰€æœ‰ç»„ä»¶éƒ½æ”¯æŒä¸­æ–­
3. **ç¬¦åˆæ ‡å‡†**ï¼šä½¿ç”¨ Pipecat å®˜æ–¹ `InterruptionFrame`
4. **ç²¾ç»†æ§åˆ¶**ï¼šæ¯ä¸ªéŸ³é¢‘å—æ£€æŸ¥ä¸­æ–­æ ‡å¿—

### ğŸ¯ æœ€ä½³å®è·µ

1. **å”¤é†’è¯è®¾è®¡**ï¼šé€‰æ‹©å®¹æ˜“è¯†åˆ«ã€ä¸æ˜“è¯¯è§¦å‘çš„å”¤é†’è¯
2. **ä¸­æ–­æç¤º**ï¼šä¸­æ–­æ—¶ç»™äºˆæ˜ç¡®çš„è¯­éŸ³æˆ–è§†è§‰åé¦ˆ
3. **çŠ¶æ€ç®¡ç†**ï¼šç¡®ä¿ä¸­æ–­åæ­£ç¡®é‡ç½®æ‰€æœ‰çŠ¶æ€
4. **æµ‹è¯•è¦†ç›–**ï¼šå®šæœŸæµ‹è¯•ä¸­æ–­åŠŸèƒ½ï¼Œç¡®ä¿å¯é æ€§

---

## 11. å‚è€ƒèµ„æ–™

- **Pipecat å®˜æ–¹æ–‡æ¡£**: https://docs.pipecat.ai/guides/learn/pipeline
- **InterruptionFrame**: SystemFrameï¼Œç«‹å³å¤„ç†
- **PipelineParams**: `allow_interruptions=True`

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-12-24
**æ¶æ„ç‰ˆæœ¬**: Pipecat v2.0ï¼ˆç¬¦åˆå®˜æ–¹æ ‡å‡†ï¼‰
